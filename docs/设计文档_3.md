# 增量设计说明（修复存档棋种误判）

本次针对“保存 json 文件默认棋局为围棋，导致再次加载按围棋规则解析”的问题，进行了以下修改与规范化。

## 问题描述
部分存档在 meta.type 缺失或使用非统一标识（如中文“围棋”或类名“GoGame”）时，加载逻辑回退默认使用围棋，导致原五子棋对局读档后按围棋规则解析。

## 设计与改动

1) 存档格式规范化
- 约定 meta.type 仅使用英文规范标识：
  - go：围棋
  - gomoku：五子棋
- 保存时统一写入上述标识，避免歧义。

2) 加载解析健壮化
- 加载时优先读取并规范化 meta.type。
- 若 meta.type 缺失，则兼容解析 data.type（可能为 GoGame/GomokuGame 或中文“围棋/五子棋”）。
- 若仍无法确定：
  - 如 meta.komi 存在，推断为围棋（go）；
  - 否则安全兜底为五子棋（gomoku），避免误将五子棋当围棋。
- UI 层 game_type 文案仍保持中文显示，但内部采用规范标识驱动工厂创建。

3) 工厂与类型规范化
- 在 core/factory.py 新增 normalize_game_type，用于将任意用户/存档提供的类型字符串映射为 'go'/'gomoku' 两个规范标识，并兼容类名与中文。

## 受影响文件
- core/factory.py：新增 normalize_game_type，统一创建逻辑。
- ui/controller.py：
  - save：存档时 meta.type 强制写入规范标识。
  - load：按优先级解析类型，回退与兜底逻辑更健壮，并与工厂对接。

## 验收要点
- 五子棋存档重新读取后保持五子棋规则，不会被当作围棋。
- 围棋存档读取后保持围棋规则，贴目等参数正确恢复。
- 旧存档（含类名或中文类型）的兼容读取正常。
